// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

//seeder
// npx ts-node  src/seeders/seeder.ts 
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int       @id @default(autoincrement())
  name      String
  email     String    @unique
  nip       String?   @unique
  username  String    @unique
  password  String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now()) @updatedAt
  deletedAt DateTime?

  Biodata    Biodata?
  UserRole   UserRole[]
  SusunanTim SusunanTim[]
  Penugasan  Penugasan[]

  OpdCreatedBy                Opd[]                 @relation("OpdCreatedBy")
  OpdUpdatedBy                Opd[]                 @relation("OpdUpdatedBy")
  JenisPengawasanCreatedBy    Jenis_pengawasan[]    @relation("JenisPengawasanCreatedBy")
  JenisPengawasanUpdatedBy    Jenis_pengawasan[]    @relation("JenisPengawasanUpdatedBy")
  KelompokPengawasanCreatedBy Kelompok_pengawasan[] @relation("KelompokPengawasanCreatedBy")
  KelompokPengawasanUpdatedBy Kelompok_pengawasan[] @relation("KelompokPengawasanUpdatedBy")
  ItemPengawasanCreatedBy     Item_pengawasan[]     @relation("ItemPengawasanCreatedBy")
  ItemPengawasanUpdatedBy     Item_pengawasan[]     @relation("ItemPengawasanUpdatedBy")
  PKPTCreatedBy               PKPT[]                @relation("PKPTCreatedBy")
  PKPTUpdatedBy               PKPT[]                @relation("PKPTUpdatedBy")
  JenisPenugasanCreatedBy     JenisPenugasan[]      @relation("JenisPenugasanCreatedBy")
  JenisPenugasanUpdatedBy     JenisPenugasan[]      @relation("JenisPenugasanUpdatedBy")
  PenugasanCreatedBy          Penugasan[]           @relation("PenugasanCreatedBy")
  PenugasanUpdatedBy          Penugasan[]           @relation("PenugasanUpdatedBy")

  ttd_katim KM1[] @relation("ttd_katim")

  ttd_ppj KM1[] @relation("ttd_ppj")
  ttd_pt  KM1[] @relation("ttd_pt") // konsisten sama KM1

  // === Tambahan untuk KM2 ===
  ttd_kasubag_umum KM2[] @relation("ttd_kasubag_umum")
  ttd_ppj_km2      KM2[] @relation("ttd_ppj_km2")
  ttd_sekretaris   KM2[] @relation("ttd_sekretaris")

  ttd_katim_km3 KM3[] @relation("ttd_katim_km3")
  ttd_pt_km3    KM3[] @relation("ttd_pt_km3")
}

model Status {
  id             Int              @id @default(autoincrement())
  name           String?
  JenisPenugasan JenisPenugasan[]
}

model Opd {
  id             Int      @id @default(autoincrement())
  kode           String
  id_skpd        Int
  id_skpd_parent Int?
  skpd_parent    String?
  nama           String
  alamat         String?
  created_at     DateTime @default(now())

  createdBy     Int?
  createdByUser User? @relation("OpdCreatedBy", fields: [createdBy], references: [id])
  updatedBy     Int?
  updatedByUser User? @relation("OpdUpdatedBy", fields: [updatedBy], references: [id])
}

model Biodata {
  id            Int       @id @default(autoincrement())
  name          String
  alamat        String?
  no_telp       String?
  kota          String?
  kode_pos      String?
  photo         String?
  tanggal_lahir DateTime?
  jenis_kelamin String?
  jabatan       String?
  pangkat       String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt //
  deletedAt     DateTime? // <== Tambahkan ini
  id_user       Int       @unique
  user          User      @relation(fields: [id_user], references: [id], onDelete: Cascade)
}

model UserRole {
  id        Int      @id @default(autoincrement())
  id_user   Int
  user      User     @relation(fields: [id_user], references: [id], onDelete: Cascade)
  id_role   Int
  role      Role     @relation(fields: [id_role], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Role {
  id             Int              @id @default(autoincrement())
  name           String           @unique
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now()) @updatedAt
  users          UserRole[]
  RolePermission RolePermission[]
}

model Permission {
  id        Int              @id @default(autoincrement())
  name      String           @unique
  createdAt DateTime         @default(now())
  updatedAt DateTime         @default(now()) @updatedAt
  roles     RolePermission[]
}

model RolePermission {
  id            Int        @id @default(autoincrement())
  id_role       Int
  id_permission Int
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @default(now()) @updatedAt
  role          Role       @relation(fields: [id_role], references: [id], onDelete: Cascade)
  permission    Permission @relation(fields: [id_permission], references: [id], onDelete: Cascade)
}

model Jenis_pengawasan {
  id                  Int                   @id @default(autoincrement())
  name                String?
  createdBy           Int
  createdByUser       User                  @relation("JenisPengawasanCreatedBy", fields: [createdBy], references: [id])
  deletedAt           DateTime?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @default(now()) @updatedAt
  updatedBy           Int?
  updatedByUser       User?                 @relation("JenisPengawasanUpdatedBy", fields: [updatedBy], references: [id])
  PKPT                PKPT[]
  Kelompok_pengawasan Kelompok_pengawasan[]
}

model Kelompok_pengawasan {
  id                  Int                   @id @default(autoincrement())
  name                String
  createdBy           Int
  createdByUser       User                  @relation("KelompokPengawasanCreatedBy", fields: [createdBy], references: [id])
  createdAt           DateTime              @default(now())
  deletedAt           DateTime?
  updatedAt           DateTime              @default(now()) @updatedAt
  updatedBy           Int?
  updatedByUser       User?                 @relation("KelompokPengawasanUpdatedBy", fields: [updatedBy], references: [id])
  id_jenis_pengawasan Int
  jenis_pengawasan    Jenis_pengawasan      @relation(fields: [id_jenis_pengawasan], references: [id], onDelete: Cascade)
  Item_pengawasan     Item_pengawasan[]
  KM2RincianPekerjaan KM2RincianPekerjaan[]
  KM3RincianPekerjaan KM3RincianPekerjaan[]
}

model Item_pengawasan {
  id Int @id @default(autoincrement())

  id_kelompok_pengawasan Int
  kelompok_pengawasan    Kelompok_pengawasan   @relation(fields: [id_kelompok_pengawasan], references: [id], onDelete: Cascade)
  name                   String
  deletedAt              DateTime?
  createdBy              Int
  createdByUser          User                  @relation("ItemPengawasanCreatedBy", fields: [createdBy], references: [id])
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @default(now()) @updatedAt
  updatedBy              Int?
  updatedByUser          User?                 @relation("ItemPengawasanUpdatedBy", fields: [updatedBy], references: [id])
  KM2RincianPekerjaan    KM2RincianPekerjaan[]
  KM3RincianPekerjaan    KM3RincianPekerjaan[]
}

model PKPT {
  id                  Int              @id @default(autoincrement())
  area_pengawasan     String
  tujuan              String
  tingkat_resiko      String           @default("Rendah")
  id_jenis_pengawasan Int
  jenis_pengawasan    Jenis_pengawasan @relation(fields: [id_jenis_pengawasan], references: [id], onDelete: Cascade)
  ruang_lingkup       String
  createdBy           Int
  createdByUser       User             @relation("PKPTCreatedBy", fields: [createdBy], references: [id])
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @default(now()) @updatedAt
  updatedBy           Int?
  updatedByUser       User?            @relation("PKPTUpdatedBy", fields: [updatedBy], references: [id])
  JenisPenugasan      JenisPenugasan[]
}

model JenisPenugasan {
  id              Int    @id @default(autoincrement())
  id_pkpt         Int?
  pkpt            PKPT?  @relation(fields: [id_pkpt], references: [id], onDelete: Cascade)
  jenis_penugasan String
  non_pkpt        Json?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @default(now()) @updatedAt
  Penugasan     Penugasan[]
  id_status     Int         @default(1)
  status        Status?     @relation(fields: [id_status], references: [id])
  createdBy     Int
  createdByUser User        @relation("JenisPenugasanCreatedBy", fields: [createdBy], references: [id])
  updatedBy     Int?
  updatedByUser User?       @relation("JenisPenugasanUpdatedBy", fields: [updatedBy], references: [id])
}

model Penugasan {
  id                 Int            @id @default(autoincrement())
  dasar_penugasan    String?
  sifat_penugasan    String?
  nama_penugasan     String?
  alamat_penugasan   String?
  catatan            String?
  nomor_kartu        String?
  id_jenis_penugasan Int
  jenis_penugasan    JenisPenugasan @relation(fields: [id_jenis_penugasan], references: [id], onDelete: Cascade)

  rute_perencanaan    RutePerencanaan[]
  km1                 KM1[]
  km2                 KM2[]
  km3                 KM3[]
  km4                 KM4[]
  susunan_tim         SusunanTim[]
  id_status_penugasan Int?
  alasan_penolakan    String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @default(now()) @updatedAt

  createdBy     Int?
  createdByUser User? @relation("PenugasanCreatedBy", fields: [createdBy], references: [id])
  updatedBy     Int?
  updatedByUser User? @relation("PenugasanUpdatedBy", fields: [updatedBy], references: [id])
  User          User? @relation(fields: [userId], references: [id])
  userId        Int?
}

model RutePerencanaan {
  id           Int       @id @default(autoincrement())
  id_penugasan Int
  penugasan    Penugasan @relation(fields: [id_penugasan], references: [id], onDelete: Cascade)

  uraian_pekerjaan String
  nama_penanggung  String
  nip              String
  tanggal_paraf    DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @default(now()) @updatedAt
}

model KM1 {
  id           Int @id @default(autoincrement())
  id_penugasan Int

  penugasan                Penugasan @relation(fields: [id_penugasan], references: [id], onDelete: Cascade)
  rencana_penugasan        String?
  tahun_penugasan_terakhir Int?
  alamat                   String?
  tingkat_risiko           String?
  tujuan_penugasan         String?
  rencana_mulai            DateTime?
  rencana_selesai          DateTime?
  anggaran_diajukan        Float?
  anggaran_disetujui       Float?
  catatan_penting          String?

  ttd_katim      Int?
  ttd_katim_user User?     @relation("ttd_katim", fields: [ttd_katim], references: [id])
  tgl_ttd_katim  DateTime?

  ttd_ppj      Int?
  ttd_ppj_user User?     @relation("ttd_ppj", fields: [ttd_ppj], references: [id])
  tgl_ttd_ppj  DateTime?

  // pakai nama prisma `ttd_pt`, tapi map ke kolom database ``
  ttd_pt      Int?      @map("ttd_pt")
  ttd_pt_user User?     @relation("ttd_pt", fields: [ttd_pt], references: [id])
  tgl_ttd_pt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model SusunanTim {
  id               Int       @id @default(autoincrement())
  id_penugasan     Int
  penugasan        Penugasan @relation(fields: [id_penugasan], references: [id], onDelete: Cascade)
  nip              String
  user             User      @relation(fields: [nip], references: [nip], onDelete: Cascade)
  peran            Peran?    @relation(fields: [id_peran], references: [id])
  id_peran         Int?
  satuan           String?
  honorarium       Int?
  alokasi_anggaran Int?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @default(now()) @updatedAt
}

model Peran {
  id           Int            @id @default(autoincrement())
  nama         String         @unique
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @default(now()) @updatedAt
  deletedAt    DateTime?
  susunan_tim  SusunanTim[]
  km3_peran    KM3Peran[]
  KM2Pelaksana KM2Pelaksana[]
}

model KM2 {
  id                     Int                   @id @default(autoincrement())
  id_penugasan           Int
  penugasan              Penugasan             @relation(fields: [id_penugasan], references: [id], onDelete: Cascade)
  sasaran_penugasan_type String                @default("lainnya")
  sasaran_penugasan      String
  km2_rincian_pekerjaan  KM2RincianPekerjaan[]

  // === Tambahan TTD ===
  ttd_kasubag_umum      Int?
  ttd_kasubag_umum_user User?     @relation("ttd_kasubag_umum", fields: [ttd_kasubag_umum], references: [id])
  tgl_ttd_kasubag_umum  DateTime?

  ttd_ppj      Int?
  ttd_ppj_user User?     @relation("ttd_ppj_km2", fields: [ttd_ppj], references: [id])
  tgl_ttd_ppj  DateTime?

  ttd_sekretaris      Int?
  ttd_sekretaris_user User?     @relation("ttd_sekretaris", fields: [ttd_sekretaris], references: [id])
  tgl_ttd_sekretaris  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model KM2RincianPekerjaan {
  id                     Int                 @id @default(autoincrement())
  id_km2                 Int
  km2                    KM2                 @relation(fields: [id_km2], references: [id], onDelete: Cascade)
  id_kelompok_pengawasan Int
  kelompok_pengawasan    Kelompok_pengawasan @relation(fields: [id_kelompok_pengawasan], references: [id], onDelete: Cascade)
  id_item_pengawasan     Int
  item_pengawasan        Item_pengawasan     @relation(fields: [id_item_pengawasan], references: [id], onDelete: Cascade)
  tanggal_awal           DateTime?
  tanggal_akhir          DateTime?
  anggaran_waktu         Int

  km2Pelaksanaan KM2Pelaksana[]
}

model KM2Pelaksana {
  id                       Int                 @id @default(autoincrement())
  id_peran                 Int
  peran                    Peran               @relation(fields: [id_peran], references: [id])
  id_km2_rincian_pekerjaan Int
  km2_rincian_pekerjaan    KM2RincianPekerjaan @relation(fields: [id_km2_rincian_pekerjaan], references: [id], onDelete: Cascade)
}

model Pelaksana {
  id   Int     @id @default(autoincrement())
  kode String  @unique
  name String?
}

model KM3 {
  id           Int       @id @default(autoincrement())
  id_penugasan Int
  penugasan    Penugasan @relation(fields: [id_penugasan], references: [id], onDelete: Cascade)

  km3_rincian_pekerjaan KM3RincianPekerjaan[]
  km3_peran             KM3Peran[]

  // === Tambahan TTD ===
  ttd_katim      Int?
  ttd_katim_user User?     @relation("ttd_katim_km3", fields: [ttd_katim], references: [id])
  tgl_ttd_katim  DateTime?

  ttd_pt      Int?
  ttd_pt_user User?     @relation("ttd_pt_km3", fields: [ttd_pt], references: [id])
  tgl_ttd_pt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model KM3Peran {
  id            Int    @id @default(autoincrement())
  id_km3        Int
  km3           KM3    @relation(fields: [id_km3], references: [id], onDelete: Cascade)
  id_peran      Int
  peran         Peran  @relation(fields: [id_peran], references: [id], onDelete: Cascade)
  rencana_jam   Float?
  realisasi_jam Float?
}

model KM3RincianPekerjaan {
  id     Int @id @default(autoincrement())
  id_km3 Int
  km3    KM3 @relation(fields: [id_km3], references: [id], onDelete: Cascade)

  id_kelompok_pengawasan Int
  kelompok_pengawasan    Kelompok_pengawasan @relation(fields: [id_kelompok_pengawasan], references: [id])

  id_item_pengawasan Int
  item_pengawasan    Item_pengawasan @relation(fields: [id_item_pengawasan], references: [id])
  rencana_jam        Float?
  anggaran_jam       Float?
  realisasi_biaya    Float?
  anggaran_biaya     Float?
}

model KM4 {
  id           Int       @id @default(autoincrement())
  id_penugasan Int
  penugasan    Penugasan @relation(fields: [id_penugasan], references: [id], onDelete: Cascade)

  tujuan String?

  KM4ProgramKerja KM4ProgramKerja[]
}

model KM4ProgramKerja {
  id              Int     @id @default(autoincrement())
  prosedur        String
  anggaran_waktu  Int
  realisasi_waktu Int
  no_kka          String?

  id_km4 Int
  km4    KM4 @relation(fields: [id_km4], references: [id], onDelete: Cascade)

  auditors KM4Auditors[]
}

model KM4Auditors {
  id   Int     @id @default(autoincrement())
  nama String
  nip  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  id_km4_program_kerja Int
  km4_program_kerja    KM4ProgramKerja @relation(fields: [id_km4_program_kerja], references: [id], onDelete: Cascade)
}
